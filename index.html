<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Besuchersch√§tzung Spieleland</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    #count, #currentSpeed, #segmentLength {
      font-size: 1.5em;
      margin: 1rem;
    }
  </style>
</head>
<body>
  <h1>Live-Besuchersch√§tzung</h1>
  <p>Basierend auf Verkehrsdaten (TomTom Traffic API)</p>
  <div id="count">Lade...</div>
  <div id="currentSpeed">Aktuelle Geschwindigkeit: Lade...</div>
  <div id="segmentLength">Abschnittsl√§nge: Lade...</div>

  <script>
    const apiKey = "EMkqdVoRLjji3gNSOkdS99HHANhiOxEl";  // Dein API-Key
    const lat = 47.709792;
    const lon = 9.591751;

    function entfernung(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function sch√§tzeBesucher() {
      try {
        const url = `https://api.tomtom.com/traffic/services/4/flowSegmentData/absolute/14/json?point=${lat},${lon}&unit=KMPH&key=${apiKey}`;
        const response = await fetch(url);
        const data = await response.json();

        const segment = data.flowSegmentData;
        const speed = segment.currentSpeed;
        const freeFlow = segment.freeFlowSpeed;
        const confidence = segment.confidence;
        const coords = segment.coordinates.coordinate;

        // Abschnittsl√§nge berechnen
        let gesamtStrecke = 0;
        for (let i = 0; i < coords.length - 1; i++) {
          const p1 = coords[i];
          const p2 = coords[i + 1];
          gesamtStrecke += entfernung(p1.latitude, p1.longitude, p2.latitude, p2.longitude);
        }
        const streckeInKm = (gesamtStrecke / 1000).toFixed(2);

        // Live anzeigen
        document.getElementById("currentSpeed").innerText = `Aktuelle Geschwindigkeit: ${speed} km/h (frei: ${freeFlow} km/h)`;
        document.getElementById("segmentLength").innerText = `Abschnittsl√§nge: ${streckeInKm} km`;

        // üö¶ Besucher-Sch√§tzmodell
        const staudifferenz = Math.max(0, freeFlow - speed);
        const staustufe = staudifferenz / freeFlow;  // z.B. 0.5 bei 50% Reduktion
        const gewichteteIntensit√§t = staustufe * confidence;

        // Basierend auf Abschnittsl√§nge (in km) & gesch√§tztem Fahrzeugfluss
        const fahrzeugeProStunde = gewichteteIntensit√§t * 1000 * streckeInKm; // grober Faktor
        const besucher = Math.round(fahrzeugeProStunde * 2.8); // 2.8 Pers. pro Fahrzeug

        document.getElementById("count").innerText = `${besucher} gesch√§tzte Besucher`;
      } catch (err) {
        console.error(err);
        document.getElementById("count").innerText = "Fehler beim Laden.";
        document.getElementById("currentSpeed").innerText = "Fehler beim Laden der Geschwindigkeit.";
        document.getElementById("segmentLength").innerText = "Fehler beim Laden der Abschnittsl√§nge.";
      }
    }

    sch√§tzeBesucher();
    setInterval(sch√§tzeBesucher, 60000);
  </script>
</body>
</html>
